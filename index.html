<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Test - User Identifier Method</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 2rem;
            text-align: center;
        }

        .test-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid #667eea;
        }

        .method-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .method-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid #e1e1e1;
        }

        .method-card.active {
            border-color: #28a745;
            background: #f8fff8;
        }

        .method-card.inactive {
            border-color: #dc3545;
            background: #fff8f8;
            opacity: 0.7;
        }

        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem;
            transition: background-color 0.3s;
        }

        .test-button:hover {
            background: #5a6fd8;
        }

        .test-button.danger {
            background: #dc3545;
        }

        .test-button.danger:hover {
            background: #c82333;
        }

        .status-display {
            background: #f1f1f1;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.9rem;
            min-height: 100px;
            overflow-y: auto;
        }

        .status-success {
            color: #28a745;
            font-weight: bold;
        }

        .status-error {
            color: #dc3545;
            font-weight: bold;
        }

        .status-info {
            color: #17a2b8;
        }

        .user-select {
            margin-bottom: 1rem;
        }

        select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .endpoint-info {
            background: #e7f3ff;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border-left: 3px solid #0066cc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Widget Authentication Test</h1>
        
        <!-- Endpoint Info -->
        <div class="endpoint-info">
            <strong>Widget Endpoint:</strong> https://solvyr-chatbot.sunrise-saas.com/sunrise-solvyr-widget.js<br>
            <strong>Auth API:</strong> https://chatbot-api-admin.sunrise-saas.com/api/get-current-user-details<br>
            <strong>Chat API:</strong> https://solvyr-chatbot.sunrise-saas.com/chat
        </div>
        
        <!-- Method Comparison -->
        <div class="method-comparison">
            <div class="method-card inactive">
                <h3>‚ùå Cookie Method</h3>
                <p>Previous approach using cookies</p>
                <ul style="margin: 1rem 0; padding-left: 1.5rem; font-size: 0.9rem;">
                    <li>Cross-domain cookie issues</li>
                    <li>Browser security blocks</li>
                    <li>Complex CORS setup</li>
                </ul>
            </div>
            
            <div class="method-card active">
                <h3>‚úÖ User Identifier Method</h3>
                <p>New approach using headers</p>
                <ul style="margin: 1rem 0; padding-left: 1.5rem; font-size: 0.9rem;">
                    <li>Works on any domain</li>
                    <li>No cookie restrictions</li>
                    <li>Simple integration</li>
                </ul>
            </div>
        </div>

        <!-- User Selection -->
        <div class="test-section">
            <h3>Test User Selection</h3>
            <div class="user-select">
                <label for="testUser">Select user to authenticate:</label>
                <select id="testUser">
                    <option value="">-- Select a user --</option>
                    <option value="chris.carswell@sunrise-saas.com">Chris Carswell (Sunrise)</option>
                    <option value="test.user@customer.com">Test User (Customer)</option>
                    <option value="invalid.user@test.com">Invalid User (Should fail)</option>
                </select>
            </div>
            
            <button onclick="testUserIdentifierAuth()" class="test-button">
                Test User Identifier Authentication
            </button>
            
            <button onclick="testDirectApiCall()" class="test-button">
                Test Direct API Call
            </button>
            
            <button onclick="initializeWidget()" class="test-button">
                Initialize Widget
            </button>
            
            <button onclick="clearStatus()" class="test-button danger">
                Clear Status
            </button>
        </div>

        <!-- Status Display -->
        <div class="test-section">
            <h3>Test Results</h3>
            <div id="statusDisplay" class="status-display">
                Ready to test. Select a user and click a test button.
            </div>
        </div>

        <!-- Widget Status -->
        <div class="test-section">
            <h3>Widget Status</h3>
            <div id="widgetStatus" class="status-display">
                Widget not initialized
            </div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const statusDiv = document.getElementById('statusDisplay');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'status-success' : 
                            type === 'error' ? 'status-error' : 'status-info';
            
            statusDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }

        function clearStatus() {
            document.getElementById('statusDisplay').innerHTML = 'Status cleared.';
            document.getElementById('widgetStatus').innerHTML = 'Widget status cleared.';
        }

        // Test direct API call with user identifier header
        async function testDirectApiCall() {
            const selectedUser = document.getElementById('testUser').value;
            
            if (!selectedUser) {
                log('Please select a user first', 'error');
                return;
            }

            log(`Testing direct API call for user: ${selectedUser}`, 'info');

            try {
                const response = await fetch('https://chatbot-api-admin.sunrise-saas.com/api/get-current-user-details', {
                    method: 'GET',
                    headers: {
                        'X-User-Identifier': selectedUser,
                        'Content-Type': 'application/json'
                    }
                });

                log(`API Response Status: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    log(`Authentication successful! User: ${data.displayName}`, 'success');
                    log(`API Token: ${data.apiToken.substring(0, 10)}...`, 'info');
                } else {
                    const errorText = await response.text();
                    log(`Authentication failed: ${errorText}`, 'error');
                }

            } catch (error) {
                log(`Network error: ${error.message}`, 'error');
            }
        }

        // Test the user identifier authentication method
        async function testUserIdentifierAuth() {
            const selectedUser = document.getElementById('testUser').value;
            
            if (!selectedUser) {
                log('Please select a user first', 'error');
                return;
            }

            log(`Testing user identifier method for: ${selectedUser}`, 'info');
            
            // This simulates what customers will do
            if (typeof SunriseSolvyr !== 'undefined') {
                log('Widget object found, testing authentication...', 'success');
                
                // Initialize widget with user identifier
                SunriseSolvyr.init({
                    userIdentifier: selectedUser,
                    position: 'bottom-right',
                    theme: {
                        primaryColor: '#f47303'  // Sunrise orange
                    }
                });
                
                log(`Widget initialized with userIdentifier: ${selectedUser}`, 'info');
                
                // Check state after initialization
                setTimeout(() => {
                    const state = SunriseSolvyr.getState();
                    log(`Widget state - isOpen: ${state.isOpen}, isAuthenticated: ${state.isAuthenticated}`, 'info');
                }, 1000);
                
            } else {
                log('SunriseSolvyr widget not loaded yet', 'error');
            }
        }

        // Initialize widget
        function initializeWidget() {
            const selectedUser = document.getElementById('testUser').value;
            
            if (!selectedUser) {
                log('Please select a user first', 'error');
                return;
            }

            const widgetStatus = document.getElementById('widgetStatus');
            
            if (typeof SunriseSolvyr !== 'undefined') {
                widgetStatus.innerHTML = `<span class="status-success">Widget loaded ‚úì</span><br>`;
                
                log(`Initializing widget for user: ${selectedUser}`, 'info');
                
                SunriseSolvyr.init({
                    userIdentifier: selectedUser,
                    position: 'bottom-right',
                    theme: {
                        primaryColor: '#f47303'  // Sunrise orange
                    }
                });
                
                widgetStatus.innerHTML += `<span class="status-info">User: ${selectedUser}</span><br>`;
                widgetStatus.innerHTML += `<span class="status-info">Method: User Identifier Header</span><br>`;
                widgetStatus.innerHTML += `<span class="status-info">Chat bubble should appear in bottom-right</span>`;
                
                // Monitor authentication status
                setTimeout(() => {
                    const state = SunriseSolvyr.getState();
                    if (state.isAuthenticated) {
                        widgetStatus.innerHTML += `<br><span class="status-success">Authentication successful ‚úì</span>`;
                    } else {
                        widgetStatus.innerHTML += `<br><span class="status-error">Authentication pending or failed</span>`;
                    }
                }, 2000);
                
            } else {
                widgetStatus.innerHTML = `<span class="status-error">Widget script not loaded ‚úó</span>`;
                log('Widget script not available', 'error');
            }
        }

        // Check widget loading
        window.addEventListener('load', function() {
            log('Page loaded, checking for widget...', 'info');
            
            setTimeout(() => {
                if (typeof SunriseSolvyr !== 'undefined') {
                    log('SunriseSolvyr widget loaded successfully!', 'success');
                    document.getElementById('widgetStatus').innerHTML = '<span class="status-success">Widget script loaded ‚úì</span>';
                } else {
                    log('Widget script failed to load', 'error');
                    document.getElementById('widgetStatus').innerHTML = '<span class="status-error">Widget script not loaded ‚úó</span>';
                }
            }, 1000);
        });
    </script>

    <!-- Load the widget from the correct endpoint -->
    <script src="https://solvyr-chatbot.sunrise-saas.com/sunrise-solvyr-widget.js"></script>
</body>
</html>
